name: ğŸ”’ Test Sistema de Permisos Automatizados

on:
  push:
    branches: [ main, develop, feature/permissions-v2.1 ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      test_level:
        description: 'Nivel de testing'
        required: true
        default: 'complete'
        type: choice
        options:
        - basic
        - complete
        - stress

env:
  DEBIAN_FRONTEND: noninteractive
  TEST_PROJECT_NAME: "test-deployment"
  TEST_DOMAIN: "example.test"

jobs:
  # ============================================================================
  # JOB 1: TESTS BÃSICOS DE ESTRUCTURA
  # ============================================================================
  test-structure:
    name: ğŸ“ Test Estructura del Proyecto
    runs-on: ubuntu-22.04
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ” Verificar estructura de directorios
      run: |
        echo "ğŸ” Verificando estructura del proyecto..."
        
        # Verificar directorios principales
        directories=("frameworks" "scripts" "db" "ssl" "make")
        for dir in "${directories[@]}"; do
          if [ -d "$dir" ]; then
            echo "âœ… $dir/ - EXISTE"
          else
            echo "âŒ $dir/ - NO EXISTE"
            exit 1
          fi
        done
        
        # Verificar archivos crÃ­ticos
        critical_files=(
          "Makefile"
          "README.md"
          "make/00-variables.mk"
          "make/00-permissions.mk"
          "make/01-setup.mk"
          "setup-permissions.sh"
          "setup-permissions-auto.sh"
        )
        
        for file in "${critical_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file - EXISTE"
          else
            echo "âŒ $file - NO EXISTE"
            exit 1
          fi
        done
        
    - name: ğŸ“‹ Verificar archivos .sh existentes
      run: |
        echo "ğŸ“‹ Listando todos los archivos .sh..."
        find . -name "*.sh" -type f | while read -r script; do
          echo "ğŸ“„ $script"
        done
        
        total_scripts=$(find . -name "*.sh" -type f | wc -l)
        echo "ğŸ“Š Total de scripts encontrados: $total_scripts"
        
        if [ $total_scripts -lt 5 ]; then
          echo "âŒ Muy pocos scripts encontrados ($total_scripts)"
          exit 1
        fi

  # ============================================================================
  # JOB 2: TESTS DEL SISTEMA DE PERMISOS
  # ============================================================================
  test-permissions-system:
    name: ğŸ”§ Test Sistema de Permisos
    runs-on: ubuntu-22.04
    needs: test-structure
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Test configuraciÃ³n automÃ¡tica de permisos
      run: |
        echo "ğŸ”§ Probando configuraciÃ³n automÃ¡tica de permisos..."
        
        # Primero, remover permisos de ejecuciÃ³n de TODOS los .sh
        echo "âŒ Removiendo permisos de ejecuciÃ³n..."
        find . -name "*.sh" -type f -exec chmod -x {} \;
        
        # Verificar que no hay scripts ejecutables
        executable_count=$(find . -name "*.sh" -type f -executable | wc -l)
        echo "ğŸ“Š Scripts ejecutables despuÃ©s de remover: $executable_count"
        
        if [ $executable_count -ne 0 ]; then
          echo "âŒ Error: AÃºn hay scripts ejecutables"
          exit 1
        fi
        
        echo "âœ… Todos los permisos removidos correctamente"
        
    - name: ğŸ”’ Test script automatizado de permisos
      run: |
        echo "ğŸ”’ Probando script automatizado..."
        
        # Hacer ejecutable solo el script de permisos
        chmod +x setup-permissions-auto.sh
        
        # Probar modo verificaciÃ³n
        echo "ğŸ” Probando modo verificaciÃ³n..."
        ./setup-permissions-auto.sh --check || true
        
        # Probar modo reparaciÃ³n
        echo "ğŸ”§ Probando modo reparaciÃ³n..."
        ./setup-permissions-auto.sh --fix
        
        # Verificar que ahora todos los scripts son ejecutables
        total_scripts=$(find . -name "*.sh" -type f | wc -l)
        executable_scripts=$(find . -name "*.sh" -type f -executable | wc -l)
        
        echo "ğŸ“Š Total de scripts: $total_scripts"
        echo "ğŸ“Š Scripts ejecutables: $executable_scripts"
        
        if [ $total_scripts -ne $executable_scripts ]; then
          echo "âŒ Error: No todos los scripts son ejecutables"
          echo "âŒ Total: $total_scripts, Ejecutables: $executable_scripts"
          exit 1
        fi
        
        echo "âœ… Todos los scripts son ejecutables"
        
    - name: ğŸ¯ Test comandos Make de permisos
      run: |
        echo "ğŸ¯ Probando comandos Make..."
        
        # Verificar que los comandos Make existen
        if ! grep -q "auto-permissions" Makefile; then
          echo "âŒ Comando auto-permissions no encontrado en Makefile"
          exit 1
        fi
        
        if ! grep -q "verify-permissions" Makefile; then
          echo "âŒ Comando verify-permissions no encontrado en Makefile"
          exit 1
        fi
        
        echo "âœ… Comandos Make encontrados"
        
        # Probar comando de verificaciÃ³n
        echo "ğŸ” Probando make verify-permissions..."
        make verify-permissions || true
        
        echo "âœ… Comandos Make ejecutados correctamente"

  # ============================================================================
  # JOB 3: TESTS DE INTEGRACIÃ“N CON MAKEFILES
  # ============================================================================
  test-makefile-integration:
    name: ğŸ“ Test IntegraciÃ³n Makefiles
    runs-on: ubuntu-22.04
    needs: test-permissions-system
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Configurar permisos iniciales
      run: |
        chmod +x setup-permissions-auto.sh
        ./setup-permissions-auto.sh --fix
        
    - name: ğŸ“ Test ayuda de comandos
      run: |
        echo "ğŸ“ Probando comandos de ayuda..."
        
        # Probar help general
        make help || true
        
        # Probar help especÃ­fico de permisos
        make help-permissions || true
        
        echo "âœ… Comandos de ayuda funcionan"
        
    - name: ğŸ”„ Test comandos de permisos completos
      run: |
        echo "ğŸ”„ Probando todos los comandos de permisos..."
        
        # Test auto-permissions
        echo "ğŸ”§ Test auto-permissions..."
        make auto-permissions || true
        
        # Test verify-permissions
        echo "ğŸ” Test verify-permissions..."
        make verify-permissions || true
        
        # Test fix-permissions
        echo "ğŸ”§ Test fix-permissions..."
        make fix-permissions || true
        
        # Test show-permissions-stats
        echo "ğŸ“Š Test show-permissions-stats..."
        make show-permissions-stats || true
        
        echo "âœ… Todos los comandos de permisos probados"

  # ============================================================================
  # JOB 4: TESTS DE SIMULACIÃ“N COMPLETA
  # ============================================================================
  test-full-simulation:
    name: ğŸ­ SimulaciÃ³n Completa de Despliegue
    runs-on: ubuntu-22.04
    needs: test-makefile-integration
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup inicial del sistema
      run: |
        echo "ğŸ”§ ConfiguraciÃ³n inicial del sistema..."
        
        # Instalar dependencias bÃ¡sicas que estarÃ­an en un servidor real
        sudo apt-get update
        sudo apt-get install -y make findutils coreutils bc
        
        # Configurar permisos iniciales
        chmod +x setup-permissions-auto.sh
        ./setup-permissions-auto.sh --fix
        
    - name: ğŸ“ Simular estructura de proyecto real
      run: |
        echo "ğŸ“ Creando estructura de proyecto simulado..."
        
        # Crear estructura que simula un proyecto real
        mkdir -p /tmp/test-projects/$TEST_PROJECT_NAME
        
        # Simular archivos de proyecto Laravel
        mkdir -p /tmp/test-projects/$TEST_PROJECT_NAME/{app,config,public,storage}
        touch /tmp/test-projects/$TEST_PROJECT_NAME/artisan
        echo '{"require": {"php": "^8.2"}}' > /tmp/test-projects/$TEST_PROJECT_NAME/composer.json
        
        echo "âœ… Estructura de proyecto simulado creada"
        
    - name: ğŸ¯ Test flujo completo de setup
      run: |
        echo "ğŸ¯ Probando flujo completo de setup..."
        
        # Crear archivo de configuraciÃ³n simulado
        cat > .deployment-config << EOF
        PROJECT_NAME=$TEST_PROJECT_NAME
        DOMAIN_NAME=$TEST_DOMAIN
        FRAMEWORK=laravel
        PHP_VERSION=8.2
        USE_NODEJS=false
        DB_TYPE=mysql
        DB_NAME=test_db
        DB_USER=test_user
        DB_PASSWORD=test_pass
        SSL_TYPE=letsencrypt
        EOF
        
        echo "âœ… ConfiguraciÃ³n simulada creada"
        
        # Probar comandos que se ejecutarÃ­an en setup real
        make verify-permissions
        make auto-permissions
        make check || true
        
        echo "âœ… Flujo de setup simulado completado"
        
    - name: ğŸ” VerificaciÃ³n final
      run: |
        echo "ğŸ” VerificaciÃ³n final del estado..."
        
        # Contar scripts y verificar estado
        total_scripts=$(find . -name "*.sh" -type f | wc -l)
        executable_scripts=$(find . -name "*.sh" -type f -executable | wc -l)
        
        echo "ğŸ“Š EstadÃ­sticas finales:"
        echo "   Total de scripts: $total_scripts"
        echo "   Scripts ejecutables: $executable_scripts"
        echo "   Porcentaje ejecutable: $(( executable_scripts * 100 / total_scripts ))%"
        
        # Verificar que al menos el 95% de scripts son ejecutables
        percentage=$(( executable_scripts * 100 / total_scripts ))
        if [ $percentage -lt 95 ]; then
          echo "âŒ Error: Solo $percentage% de scripts son ejecutables"
          exit 1
        fi
        
        echo "âœ… Estado final verificado correctamente"

  # ============================================================================
  # JOB 5: TEST LOCAL SCRIPT
  # ============================================================================
  test-local-script:
    name: ğŸ§ª Test Script Local
    runs-on: ubuntu-22.04
    needs: test-structure
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ§ª Ejecutar test local automatizado
      run: |
        # Crear y ejecutar el script de test local
        chmod +x test-permissions-local.sh
        
        echo "ğŸ§ª Ejecutando test local completo..."
        ./test-permissions-local.sh --all --report
        
    - name: ğŸ“‹ Mostrar reporte generado
      run: |
        echo "ğŸ“‹ Contenido del reporte generado:"
        latest_report=$(ls -t /tmp/permissions-test-report-*.md 2>/dev/null | head -1)
        if [ -f "$latest_report" ]; then
          cat "$latest_report"
        else
          echo "âš ï¸  No se encontrÃ³ reporte generado"
        fi

  # ============================================================================
  # JOB 6: REPORTE FINAL
  # ============================================================================
  test-report:
    name: ğŸ“Š Reporte Final de Tests
    runs-on: ubuntu-22.04
    needs: [test-structure, test-permissions-system, test-makefile-integration, test-full-simulation, test-local-script]
    if: always()
    
    steps:
    - name: ğŸ“Š Generar reporte de resultados
      run: |
        echo "ğŸ“Š REPORTE FINAL DE TESTS - Sistema de Permisos v2.1"
        echo "=================================================="
        echo ""
        echo "ğŸ” Estado de los jobs:"
        echo "  âœ… test-structure: ${{ needs.test-structure.result }}"
        echo "  âœ… test-permissions-system: ${{ needs.test-permissions-system.result }}"
        echo "  âœ… test-makefile-integration: ${{ needs.test-makefile-integration.result }}"
        echo "  âœ… test-full-simulation: ${{ needs.test-full-simulation.result }}"
        echo "  âœ… test-local-script: ${{ needs.test-local-script.result }}"
        echo ""
        
        echo "ğŸ¯ Funcionalidades probadas:"
        echo "  âœ… DetecciÃ³n automÃ¡tica de archivos .sh"
        echo "  âœ… ConfiguraciÃ³n masiva de permisos"
        echo "  âœ… VerificaciÃ³n de estado"
        echo "  âœ… ReparaciÃ³n automÃ¡tica"
        echo "  âœ… IntegraciÃ³n con Makefiles"
        echo "  âœ… Comandos de ayuda"
        echo "  âœ… Script de test local"
        echo "  âœ… SimulaciÃ³n de despliegue completo"
        echo ""
        
        # Verificar si todos los jobs pasaron
        if [ "${{ needs.test-structure.result }}" = "success" ] && \
           [ "${{ needs.test-permissions-system.result }}" = "success" ] && \
           [ "${{ needs.test-makefile-integration.result }}" = "success" ] && \
           [ "${{ needs.test-full-simulation.result }}" = "success" ] && \
           [ "${{ needs.test-local-script.result }}" = "success" ]; then
          echo "ğŸš€ CONCLUSIÃ“N: Sistema de permisos automatizados LISTO para producciÃ³n"
          echo "âœ… TODOS LOS TESTS PASARON"
        else
          echo "âŒ ALGUNOS TESTS FALLARON - Revisar antes de desplegar"
          exit 1
        fi
