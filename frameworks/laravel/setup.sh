#!/bin/bash

# Script de configuraci√≥n espec√≠fico para Laravel
# Multi-Framework Deployment Environment - Comunidad Latina
# Autor: Contribuciones de la comunidad

# Colores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_status() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[AVISO]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_header() {
    echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${BLUE}‚ïë                    Configuraci√≥n Laravel                    ‚ïë${NC}"
    echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
}

# Leer configuraci√≥n del deployment
read_deployment_config() {
    if [ ! -f ".deployment-config" ]; then
        print_error "Archivo de configuraci√≥n no encontrado"
        exit 1
    fi

    export $(cat .deployment-config | xargs)

    print_status "Configuraci√≥n del deployment cargada:"
    echo "  üìÅ Proyecto: $PROJECT_NAME"
    echo "  üåê Dominio: $DOMAIN_NAME"
    echo "  üêò PHP: $PHP_VERSION"
    echo "  üì¶ Node.js: ${USE_NODEJS:-false}"
    if [ "$USE_NODEJS" = "true" ]; then
        echo "  üì¶ Versi√≥n Node.js: $NODEJS_VERSION"
    fi
    echo "  üóÑÔ∏è  Base de datos: $DB_TYPE"
}

# Configurar Laravel espec√≠ficamente
configure_laravel() {
    print_status "Configurando proyecto Laravel..."

    PROJECT_PATH="/var/www/$PROJECT_NAME"
    
    # Verificar que es un proyecto Laravel v√°lido
    if [ ! -f "$PROJECT_PATH/artisan" ]; then
        print_error "No se encontr√≥ el archivo artisan. ¬øEs este un proyecto Laravel v√°lido?"
        exit 1
    fi

    cd "$PROJECT_PATH"

    # Crear archivo .env si no existe
    if [ ! -f ".env" ]; then
        if [ -f ".env.example" ]; then
            cp .env.example .env
            print_status "Archivo .env creado desde .env.example"
        else
            print_warning "No se encontr√≥ .env.example, creando .env b√°sico"
            create_basic_env
        fi
    else
        print_status "Archivo .env existente encontrado"
    fi

    # Actualizar configuraci√≥n de base de datos en .env
    update_database_config

    # Actualizar configuraci√≥n de aplicaci√≥n
    update_app_config

    # Instalar dependencias
    install_dependencies

    # Generar clave de aplicaci√≥n
    generate_app_key

    # Ejecutar migraciones
    run_migrations

    # Configurar storage links
    setup_storage_links

    # Optimizar para producci√≥n
    optimize_for_production

    print_status "‚úÖ Configuraci√≥n de Laravel completada"
}

# Crear archivo .env b√°sico
create_basic_env() {
    # Configurar valores de cache seg√∫n la selecci√≥n
    local cache_driver="file"
    local session_driver="file"
    local queue_connection="sync"
    local redis_password="null"
    
    if [ "$CACHE_TYPE" = "redis" ]; then
        cache_driver="redis"
        session_driver="redis"
        queue_connection="redis"
        redis_password="${REDIS_PASSWORD:-null}"
    elif [ "$CACHE_TYPE" = "memcached" ]; then
        cache_driver="memcached"
        session_driver="memcached"
        queue_connection="database"
    elif [ "$CACHE_TYPE" = "database" ]; then
        cache_driver="database"
        session_driver="database"
        queue_connection="database"
    fi
    
    cat > .env << EOF
APP_NAME="$PROJECT_NAME"
APP_ENV=production
APP_KEY=
APP_DEBUG=false
APP_URL=https://$DOMAIN_NAME

LOG_CHANNEL=stack
LOG_DEPRECATIONS_CHANNEL=null
LOG_LEVEL=error

DB_CONNECTION=$DB_TYPE
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=$DB_NAME
DB_USERNAME=$DB_USER
DB_PASSWORD=$DB_PASSWORD

BROADCAST_DRIVER=log
CACHE_DRIVER=$cache_driver
FILESYSTEM_DISK=local
QUEUE_CONNECTION=$queue_connection
SESSION_DRIVER=$session_driver
SESSION_LIFETIME=120

MEMCACHED_HOST=127.0.0.1

REDIS_HOST=127.0.0.1
REDIS_PASSWORD=$redis_password
REDIS_PORT=6379

MAIL_MAILER=smtp
MAIL_HOST=mailpit
MAIL_PORT=1025
MAIL_USERNAME=null
MAIL_PASSWORD=null
MAIL_ENCRYPTION=null
MAIL_FROM_ADDRESS="hello@$DOMAIN_NAME"
MAIL_FROM_NAME="\${APP_NAME}"

AWS_ACCESS_KEY_ID=
AWS_SECRET_ACCESS_KEY=
AWS_DEFAULT_REGION=us-east-1
AWS_BUCKET=
AWS_USE_PATH_STYLE_ENDPOINT=false

PUSHER_APP_ID=
PUSHER_APP_KEY=
PUSHER_APP_SECRET=
PUSHER_HOST=
PUSHER_PORT=443
PUSHER_SCHEME=https
PUSHER_APP_CLUSTER=mt1

VITE_PUSHER_APP_KEY="\${PUSHER_APP_KEY}"
VITE_PUSHER_HOST="\${PUSHER_HOST}"
VITE_PUSHER_PORT="\${PUSHER_PORT}"
VITE_PUSHER_SCHEME="\${PUSHER_SCHEME}"
VITE_PUSHER_APP_CLUSTER="\${PUSHER_APP_CLUSTER}"
EOF
}

# Actualizar configuraci√≥n de base de datos
update_database_config() {
    print_status "Actualizando configuraci√≥n de base de datos..."

    # Actualizar configuraci√≥n de base de datos
    sed -i "s/^DB_CONNECTION=.*/DB_CONNECTION=$DB_TYPE/" .env
    sed -i "s/^DB_HOST=.*/DB_HOST=127.0.0.1/" .env
    sed -i "s/^DB_PORT=.*/DB_PORT=3306/" .env
    sed -i "s/^DB_DATABASE=.*/DB_DATABASE=$DB_NAME/" .env
    sed -i "s/^DB_USERNAME=.*/DB_USERNAME=$DB_USER/" .env
    sed -i "s/^DB_PASSWORD=.*/DB_PASSWORD=$DB_PASSWORD/" .env

    print_status "Configuraci√≥n de base de datos actualizada"
}

# Actualizar configuraci√≥n de aplicaci√≥n
update_app_config() {
    print_status "Actualizando configuraci√≥n de aplicaci√≥n..."

    # Actualizar configuraciones b√°sicas
    sed -i "s/^APP_NAME=.*/APP_NAME=\"$PROJECT_NAME\"/" .env
    sed -i "s/^APP_ENV=.*/APP_ENV=production/" .env
    sed -i "s/^APP_DEBUG=.*/APP_DEBUG=false/" .env
    sed -i "s|^APP_URL=.*|APP_URL=https://$DOMAIN_NAME|" .env

    # Configurar cache seg√∫n la selecci√≥n del usuario
    if [ "$CACHE_TYPE" = "redis" ]; then
        sed -i "s/^CACHE_DRIVER=.*/CACHE_DRIVER=redis/" .env
        sed -i "s/^SESSION_DRIVER=.*/SESSION_DRIVER=redis/" .env
        sed -i "s/^QUEUE_CONNECTION=.*/QUEUE_CONNECTION=redis/" .env
        # Configurar password Redis si existe
        if [ -n "$REDIS_PASSWORD" ]; then
            sed -i "s/^REDIS_PASSWORD=.*/REDIS_PASSWORD=$REDIS_PASSWORD/" .env
        fi
    elif [ "$CACHE_TYPE" = "memcached" ]; then
        sed -i "s/^CACHE_DRIVER=.*/CACHE_DRIVER=memcached/" .env
        sed -i "s/^SESSION_DRIVER=.*/SESSION_DRIVER=memcached/" .env
        sed -i "s/^QUEUE_CONNECTION=.*/QUEUE_CONNECTION=database/" .env
    elif [ "$CACHE_TYPE" = "database" ]; then
        sed -i "s/^CACHE_DRIVER=.*/CACHE_DRIVER=database/" .env
        sed -i "s/^SESSION_DRIVER=.*/SESSION_DRIVER=database/" .env
        sed -i "s/^QUEUE_CONNECTION=.*/QUEUE_CONNECTION=database/" .env
    elif [ "$CACHE_TYPE" = "file" ]; then
        sed -i "s/^CACHE_DRIVER=.*/CACHE_DRIVER=file/" .env
        sed -i "s/^SESSION_DRIVER=.*/SESSION_DRIVER=file/" .env
        sed -i "s/^QUEUE_CONNECTION=.*/QUEUE_CONNECTION=database/" .env
    else
        # Sin cache - configuraci√≥n b√°sica
        sed -i "s/^CACHE_DRIVER=.*/CACHE_DRIVER=array/" .env
        sed -i "s/^SESSION_DRIVER=.*/SESSION_DRIVER=file/" .env
        sed -i "s/^QUEUE_CONNECTION=.*/QUEUE_CONNECTION=sync/" .env
    fi

    # Configurar logs
    sed -i "s/^LOG_LEVEL=.*/LOG_LEVEL=error/" .env

    print_status "Configuraci√≥n de aplicaci√≥n actualizada"
}

# Instalar dependencias
install_dependencies() {
    print_status "Instalando dependencias de Laravel..."

    # Cambiar al usuario www-data para ejecutar composer
    if command -v composer &> /dev/null; then
        # Verificar si composer.lock existe y tiene problemas de compatibilidad
        if [ -f "composer.lock" ]; then
            print_warning "Detectado composer.lock, verificando compatibilidad..."
            # Intentar composer install primero
            if ! sudo -u www-data composer install --no-dev --optimize-autoloader --no-interaction 2>/dev/null; then
                print_warning "Composer install fall√≥, ejecutando composer update..."
                sudo -u www-data composer update --no-dev --optimize-autoloader --no-interaction
            fi
        else
            # Si no hay composer.lock, hacer install normal
            sudo -u www-data composer install --no-dev --optimize-autoloader --no-interaction
        fi
        print_status "Dependencias de Composer instaladas"
    else
        print_error "Composer no est√° instalado"
        exit 1
    fi

    # Instalar dependencias de Node.js si est√° configurado
    if [ "$USE_NODEJS" = "true" ]; then
        if command -v npm &> /dev/null; then
            sudo -u www-data npm install
            print_status "Dependencias de Node.js instaladas"
            
            # Compilar assets
            if [ -f "package.json" ]; then
                if grep -q "vite" package.json; then
                    sudo -u www-data npm run build
                    print_status "Assets compilados con Vite"
                elif grep -q "mix" package.json; then
                    sudo -u www-data npm run production
                    print_status "Assets compilados con Laravel Mix"
                else
                    print_warning "No se detect√≥ Vite ni Mix, saltando compilaci√≥n de assets"
                fi
            fi
        else
            print_warning "Node.js no est√° disponible, saltando dependencias de frontend"
        fi
    else
        print_status "Node.js omitido seg√∫n configuraci√≥n"
    fi
}

# Generar clave de aplicaci√≥n
generate_app_key() {
    print_status "Generando clave de aplicaci√≥n..."

    if ! grep -q "APP_KEY=base64:" .env; then
        php artisan key:generate --force
        print_status "Clave de aplicaci√≥n generada"
    else
        print_status "Clave de aplicaci√≥n ya existe"
    fi
}

# Ejecutar migraciones
run_migrations() {
    print_status "Ejecutando migraciones de base de datos..."

    # Verificar conexi√≥n a la base de datos
    if php artisan migrate:status &>/dev/null; then
        php artisan migrate --force
        print_status "Migraciones ejecutadas correctamente"
    else
        print_warning "No se pudo conectar a la base de datos o no hay migraciones"
    fi
}

# Configurar storage links
setup_storage_links() {
    print_status "Configurando enlaces de storage..."

    # Crear enlace simb√≥lico de storage
    if [ ! -L "public/storage" ]; then
        php artisan storage:link
        print_status "Enlace de storage creado"
    else
        print_status "Enlace de storage ya existe"
    fi
}

# Optimizar para producci√≥n
optimize_for_production() {
    print_status "Optimizando Laravel para producci√≥n..."

    # Limpiar cache existente
    php artisan config:clear
    php artisan route:clear
    php artisan view:clear
    php artisan cache:clear

    # Crear cache optimizado
    php artisan config:cache
    php artisan route:cache
    php artisan view:cache

    # Optimizar autoload de Composer
    composer dump-autoload --optimize --no-dev

    print_status "Optimizaci√≥n completada"
}

# Configurar permisos espec√≠ficos de Laravel
set_laravel_permissions() {
    print_status "Configurando permisos espec√≠ficos de Laravel..."

    PROJECT_PATH="/var/www/$PROJECT_NAME"

    # Configurar Git safe directory
    if [ -d "$PROJECT_PATH/.git" ]; then
        print_status "Configurando Git safe directory..."
        sudo -u www-data git config --global --add safe.directory "$PROJECT_PATH"
    fi

    # Establecer propietario
    sudo chown -R www-data:www-data "$PROJECT_PATH"

    # Permisos generales
    sudo chmod -R 755 "$PROJECT_PATH"

    # Permisos espec√≠ficos para directorios de Laravel
    sudo chmod -R 775 "$PROJECT_PATH/storage"
    sudo chmod -R 775 "$PROJECT_PATH/bootstrap/cache"

    # Si existe directorio public/storage
    if [ -d "$PROJECT_PATH/public/storage" ]; then
        sudo chmod -R 775 "$PROJECT_PATH/public/storage"
    fi

    print_status "Permisos configurados correctamente"
}

# Verificar instalaci√≥n
verify_laravel_installation() {
    print_status "Verificando instalaci√≥n de Laravel..."

    PROJECT_PATH="/var/www/$PROJECT_NAME"
    cd "$PROJECT_PATH"

    # Verificar que Laravel puede ejecutarse
    if sudo -u www-data php artisan --version &>/dev/null; then
        LARAVEL_VERSION=$(sudo -u www-data php artisan --version | head -n1)
        print_status "‚úÖ Laravel funcionando correctamente: $LARAVEL_VERSION"
    else
        print_error "‚ùå Laravel no puede ejecutarse correctamente"
        return 1
    fi

    # Verificar conexi√≥n a base de datos
    print_status "Verificando conexi√≥n a base de datos..."
    if sudo -u www-data php artisan migrate:status &>/dev/null; then
        print_status "‚úÖ Conexi√≥n a base de datos verificada"
    else
        print_warning "‚ö†Ô∏è  No se pudo verificar la conexi√≥n a la base de datos"
        print_warning "Verifica la configuraci√≥n de DB en .env"
    fi

    # Verificar configuraci√≥n de cache
    print_status "Verificando configuraci√≥n de cache..."
    if [ "$CACHE_TYPE" = "redis" ]; then
        # Verificar conexi√≥n Redis
        if redis-cli ping &>/dev/null; then
            print_status "‚úÖ Redis conectado correctamente"
        else
            print_warning "‚ö†Ô∏è  Redis no responde"
            print_warning "Verificando configuraci√≥n Redis..."
            # Intentar reiniciar Redis
            sudo systemctl restart redis-server
            sleep 2
            if redis-cli ping &>/dev/null; then
                print_status "‚úÖ Redis reiniciado y funcionando"
            else
                print_error "‚ùå Redis no puede conectar"
            fi
        fi
    fi

    if sudo -u www-data php artisan config:show app.name &>/dev/null; then
        print_status "‚úÖ Configuraci√≥n cacheada correctamente"
    else
        print_warning "‚ö†Ô∏è  Problema con la configuraci√≥n cacheada"
    fi

    print_status "Verificaci√≥n completada"
}

# Mostrar informaci√≥n final
show_laravel_info() {
    echo ""
    echo -e "${GREEN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${GREEN}‚ïë                Laravel Configurado Exitosamente             ‚ïë${NC}"
    echo -e "${GREEN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    echo -e "${CYAN}üöÄ Framework:${NC} Laravel"
    echo -e "${CYAN}üìÅ Proyecto:${NC} $PROJECT_NAME"
    echo -e "${CYAN}üåê URL:${NC} https://$DOMAIN_NAME"
    echo -e "${CYAN}üóÑÔ∏è  Base de datos:${NC} $DB_NAME ($DB_TYPE)"
    echo ""
    echo -e "${YELLOW}üìã Comandos √∫tiles:${NC}"
    echo -e "${YELLOW}‚Ä¢ Ver logs:${NC} tail -f /var/www/$PROJECT_NAME/storage/logs/laravel.log"
    echo -e "${YELLOW}‚Ä¢ Limpiar cache:${NC} cd /var/www/$PROJECT_NAME && php artisan cache:clear"
    echo -e "${YELLOW}‚Ä¢ Ejecutar migraciones:${NC} cd /var/www/$PROJECT_NAME && php artisan migrate"
    echo -e "${YELLOW}‚Ä¢ Ver estado de queue:${NC} cd /var/www/$PROJECT_NAME && php artisan queue:work"
    echo ""
}

# Funci√≥n principal
main() {
    print_header

    read_deployment_config
    echo ""

    configure_laravel
    echo ""

    set_laravel_permissions
    echo ""

    verify_laravel_installation
    echo ""

    show_laravel_info
}

# Ejecutar funci√≥n principal
main