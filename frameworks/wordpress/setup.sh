#!/bin/bash

# Script de configuraci√≥n espec√≠fico para WordPress
# Multi-Framework Deployment Environment - Comunidad Latina
# Autor: Contribuciones de la comunidad

# Colores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_status() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[AVISO]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_header() {
    echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${BLUE}‚ïë                   Configuraci√≥n WordPress                   ‚ïë${NC}"
    echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
}

# Leer configuraci√≥n del deployment
read_deployment_config() {
    if [ ! -f ".deployment-config" ]; then
        print_error "Archivo de configuraci√≥n no encontrado"
        exit 1
    fi

    export $(cat .deployment-config | xargs)

    print_status "Configuraci√≥n del deployment cargada:"
    echo "  üìÅ Proyecto: $PROJECT_NAME"
    echo "  üåê Dominio: $DOMAIN_NAME"
    echo "  üêò PHP: $PHP_VERSION"
    echo "  üì¶ Node.js: ${USE_NODEJS:-false}"
    if [ "$USE_NODEJS" = "true" ]; then
        echo "  üì¶ Versi√≥n Node.js: $NODEJS_VERSION"
    fi
    echo "  üóÑÔ∏è  Base de datos: $DB_TYPE"
    echo "  üè∑Ô∏è  Sufijo tablas: $TABLE_PREFIX"
}

# Configurar WordPress espec√≠ficamente
configure_wordpress() {
    print_status "Configurando proyecto WordPress..."

    PROJECT_PATH="/var/www/$PROJECT_NAME"
    
    # Verificar que es un proyecto WordPress v√°lido
    if [ ! -f "$PROJECT_PATH/wp-load.php" ]; then
        print_error "No se encontr√≥ el archivo wp-load.php. ¬øEs este un proyecto WordPress v√°lido?"
        exit 1
    fi

    cd "$PROJECT_PATH"

    # Crear archivo wp-config.php si no existe
    if [ ! -f "wp-config.php" ]; then
        if [ -f "wp-config-sample.php" ]; then
            cp wp-config-sample.php wp-config.php
            print_status "Archivo wp-config.php creado desde wp-config-sample.php"
        else
            print_warning "No se encontr√≥ wp-config-sample.php, creando wp-config.php b√°sico"
            create_basic_wp_config
        fi
    else
        print_status "Archivo wp-config.php existente encontrado"
    fi

    # Actualizar configuraci√≥n de base de datos en wp-config.php
    update_database_config

    # Generar claves de seguridad
    generate_security_keys

    # Configurar constantes adicionales
    configure_wp_constants

    # Instalar WP-CLI si no est√° disponible
    install_wp_cli

    # Descargar idioma espa√±ol si es necesario
    configure_language

    # Optimizar para producci√≥n
    optimize_for_production

    print_status "‚úÖ Configuraci√≥n de WordPress completada"
}

# Crear archivo wp-config.php b√°sico
create_basic_wp_config() {
    cat > wp-config.php << 'EOF'
<?php
/**
 * Configuraci√≥n b√°sica de WordPress.
 * 
 * Este archivo contiene la configuraci√≥n de la base de datos y otras
 * configuraciones espec√≠ficas para WordPress.
 * 
 * @package WordPress
 */

// ** Configuraci√≥n de Base de Datos ** //
define( 'DB_NAME', 'DB_NAME_PLACEHOLDER' );
define( 'DB_USER', 'DB_USER_PLACEHOLDER' );
define( 'DB_PASSWORD', 'DB_PASSWORD_PLACEHOLDER' );
define( 'DB_HOST', 'localhost' );
define( 'DB_CHARSET', 'utf8mb4' );
define( 'DB_COLLATE', '' );

/**#@+
 * Claves √∫nicas de autenticaci√≥n y salts.
 * 
 * SECURITY_KEYS_PLACEHOLDER
 * 
 * @since 2.6.0
 */
// Las claves de seguridad ser√°n generadas autom√°ticamente

/**#@-*/

/**
 * Prefijo de la base de datos de WordPress.
 */
$table_prefix = 'TABLE_PREFIX_PLACEHOLDER';

/**
 * Para desarrolladores: modo de depuraci√≥n de WordPress.
 */
define( 'WP_DEBUG', false );
define( 'WP_DEBUG_LOG', false );
define( 'WP_DEBUG_DISPLAY', false );

/* Configuraciones adicionales de seguridad y rendimiento */
define( 'DISALLOW_FILE_EDIT', true );
define( 'WP_POST_REVISIONS', 3 );
define( 'EMPTY_TRASH_DAYS', 30 );
define( 'WP_MEMORY_LIMIT', '256M' );
define( 'WP_CACHE', true );

/* SSL */
if ( isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ) {
    define( 'FORCE_SSL_ADMIN', true );
}

/* ¬°Eso es todo, deja de editar! Feliz publicaci√≥n. */

/** Ruta absoluta al directorio de WordPress. */
if ( ! defined( 'ABSPATH' ) ) {
	define( 'ABSPATH', __DIR__ . '/' );
}

/** Configura las variables de WordPress y archivos incluidos. */
require_once ABSPATH . 'wp-settings.php';
EOF
}

# Actualizar configuraci√≥n de base de datos
update_database_config() {
    print_status "Actualizando configuraci√≥n de base de datos en wp-config.php..."

    # Reemplazar configuraciones de base de datos
    sed -i "s/DB_NAME_PLACEHOLDER/$DB_NAME/g" wp-config.php
    sed -i "s/DB_USER_PLACEHOLDER/$DB_USER/g" wp-config.php
    sed -i "s/DB_PASSWORD_PLACEHOLDER/$DB_PASSWORD/g" wp-config.php
    sed -i "s/TABLE_PREFIX_PLACEHOLDER/$TABLE_PREFIX/g" wp-config.php

    # Actualizar configuraciones existentes si ya existen
    sed -i "s/define( 'DB_NAME', '.*' );/define( 'DB_NAME', '$DB_NAME' );/" wp-config.php
    sed -i "s/define( 'DB_USER', '.*' );/define( 'DB_USER', '$DB_USER' );/" wp-config.php
    sed -i "s/define( 'DB_PASSWORD', '.*' );/define( 'DB_PASSWORD', '$DB_PASSWORD' );/" wp-config.php
    sed -i "s/\$table_prefix = '.*';/\$table_prefix = '$TABLE_PREFIX';/" wp-config.php

    print_status "Configuraci√≥n de base de datos actualizada"
}

# Generar claves de seguridad de WordPress
generate_security_keys() {
    print_status "Generando claves de seguridad de WordPress..."

    # Generar claves usando la API de WordPress o generar localmente
    if command -v curl &> /dev/null; then
        SECURITY_KEYS=$(curl -s https://api.wordpress.org/secret-key/1.1/salt/)
        if [ $? -eq 0 ] && [ -n "$SECURITY_KEYS" ]; then
            # Reemplazar placeholder con las claves reales
            sed -i "/SECURITY_KEYS_PLACEHOLDER/c\\$SECURITY_KEYS" wp-config.php
            print_status "Claves de seguridad obtenidas de WordPress.org"
        else
            generate_local_security_keys
        fi
    else
        generate_local_security_keys
    fi
}

# Generar claves de seguridad localmente
generate_local_security_keys() {
    print_status "Generando claves de seguridad localmente..."

    # Generar claves aleatorias localmente
    AUTH_KEY=$(openssl rand -base64 64)
    SECURE_AUTH_KEY=$(openssl rand -base64 64)
    LOGGED_IN_KEY=$(openssl rand -base64 64)
    NONCE_KEY=$(openssl rand -base64 64)
    AUTH_SALT=$(openssl rand -base64 64)
    SECURE_AUTH_SALT=$(openssl rand -base64 64)
    LOGGED_IN_SALT=$(openssl rand -base64 64)
    NONCE_SALT=$(openssl rand -base64 64)

    SECURITY_KEYS="define( 'AUTH_KEY',         '$AUTH_KEY' );
define( 'SECURE_AUTH_KEY',  '$SECURE_AUTH_KEY' );
define( 'LOGGED_IN_KEY',    '$LOGGED_IN_KEY' );
define( 'NONCE_KEY',        '$NONCE_KEY' );
define( 'AUTH_SALT',        '$AUTH_SALT' );
define( 'SECURE_AUTH_SALT', '$SECURE_AUTH_SALT' );
define( 'LOGGED_IN_SALT',   '$LOGGED_IN_SALT' );
define( 'NONCE_SALT',       '$NONCE_SALT' );"

    # Reemplazar placeholder con las claves generadas
    sed -i "/SECURITY_KEYS_PLACEHOLDER/c\\$SECURITY_KEYS" wp-config.php
    print_status "Claves de seguridad generadas localmente"
}

# Configurar constantes adicionales de WordPress
configure_wp_constants() {
    print_status "Configurando constantes adicionales de WordPress..."

    # Verificar y agregar constantes si no existen
    if ! grep -q "DISALLOW_FILE_EDIT" wp-config.php; then
        sed -i "/define( 'WP_DEBUG'/i\\define( 'DISALLOW_FILE_EDIT', true );" wp-config.php
    fi

    if ! grep -q "WP_POST_REVISIONS" wp-config.php; then
        sed -i "/define( 'WP_DEBUG'/i\\define( 'WP_POST_REVISIONS', 3 );" wp-config.php
    fi

    if ! grep -q "EMPTY_TRASH_DAYS" wp-config.php; then
        sed -i "/define( 'WP_DEBUG'/i\\define( 'EMPTY_TRASH_DAYS', 30 );" wp-config.php
    fi

    if ! grep -q "WP_MEMORY_LIMIT" wp-config.php; then
        sed -i "/define( 'WP_DEBUG'/i\\define( 'WP_MEMORY_LIMIT', '256M' );" wp-config.php
    fi

    if ! grep -q "FORCE_SSL_ADMIN" wp-config.php; then
        sed -i "/define( 'WP_DEBUG'/i\\define( 'FORCE_SSL_ADMIN', true );" wp-config.php
    fi

    # Configurar para producci√≥n
    sed -i "s/define( 'WP_DEBUG', true );/define( 'WP_DEBUG', false );/" wp-config.php
    sed -i "s/define( 'WP_DEBUG_LOG', true );/define( 'WP_DEBUG_LOG', false );/" wp-config.php
    sed -i "s/define( 'WP_DEBUG_DISPLAY', true );/define( 'WP_DEBUG_DISPLAY', false );/" wp-config.php

    print_status "Constantes de WordPress configuradas"
}

# Instalar WP-CLI
install_wp_cli() {
    if ! command -v wp &> /dev/null; then
        print_status "Instalando WP-CLI..."
        curl -O https://raw.githubusercontent.com/wp-cli/wp-cli/v2.8.1/bin/wp-cli.phar
        chmod +x wp-cli.phar
        sudo mv wp-cli.phar /usr/local/bin/wp
        print_status "WP-CLI instalado correctamente"
    else
        print_status "WP-CLI ya est√° instalado"
    fi
}

# Configurar idioma
configure_language() {
    print_status "Configurando idioma espa√±ol para WordPress..."

    # Verificar si WP-CLI est√° disponible y configurar idioma
    if command -v wp &> /dev/null; then
        # Descargar idioma espa√±ol
        sudo -u www-data wp --path="$PROJECT_PATH" language core install es_ES --allow-root 2>/dev/null || true
        
        # Configurar idioma en wp-config.php
        if ! grep -q "WPLANG" wp-config.php; then
            sed -i "/define( 'WP_DEBUG'/i\\define( 'WPLANG', 'es_ES' );" wp-config.php
        fi
        
        print_status "Idioma espa√±ol configurado"
    else
        print_warning "WP-CLI no disponible, idioma no configurado autom√°ticamente"
    fi
}

# Configurar permisos espec√≠ficos de WordPress
set_wordpress_permissions() {
    print_status "Configurando permisos espec√≠ficos de WordPress..."

    PROJECT_PATH="/var/www/$PROJECT_NAME"

    # Establecer propietario
    sudo chown -R www-data:www-data "$PROJECT_PATH"

    # Permisos generales
    sudo chmod -R 755 "$PROJECT_PATH"

    # Permisos espec√≠ficos para archivos
    sudo find "$PROJECT_PATH" -type f -exec chmod 644 {} \;

    # Permisos espec√≠ficos para directorios de WordPress
    sudo chmod -R 775 "$PROJECT_PATH/wp-content"
    
    # Crear y configurar directorio de uploads si no existe
    if [ ! -d "$PROJECT_PATH/wp-content/uploads" ]; then
        sudo mkdir -p "$PROJECT_PATH/wp-content/uploads"
    fi
    sudo chmod -R 775 "$PROJECT_PATH/wp-content/uploads"
    sudo chmod -R 775 "$PROJECT_PATH/wp-content/plugins"
    sudo chmod -R 775 "$PROJECT_PATH/wp-content/themes"

    # Permisos m√°s restrictivos para wp-config.php
    sudo chmod 600 "$PROJECT_PATH/wp-config.php"

    print_status "Permisos configurados correctamente"
}

# Optimizar para producci√≥n
optimize_for_production() {
    print_status "Optimizando WordPress para producci√≥n..."

    PROJECT_PATH="/var/www/$PROJECT_NAME"
    cd "$PROJECT_PATH"

    # Instalar y configurar plugins esenciales si WP-CLI est√° disponible
    if command -v wp &> /dev/null; then
        # Actualizar WordPress core
        sudo -u www-data wp --path="$PROJECT_PATH" core update --allow-root 2>/dev/null || true
        print_status "WordPress actualizado"
    fi

    # Crear archivo .htaccess b√°sico para permalinks
    if [ ! -f ".htaccess" ]; then
        cat > .htaccess << 'EOF'
# BEGIN WordPress
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
RewriteBase /
RewriteRule ^index\.php$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /index.php [L]
</IfModule>
# END WordPress

# Seguridad adicional
<Files wp-config.php>
order allow,deny
deny from all
</Files>

<Files .htaccess>
order allow,deny
deny from all
</Files>
EOF
        sudo chown www-data:www-data .htaccess
        sudo chmod 644 .htaccess
        print_status "Archivo .htaccess creado"
    fi

    print_status "Optimizaci√≥n completada"
}

# Verificar instalaci√≥n de WordPress
verify_wordpress_installation() {
    print_status "Verificando instalaci√≥n de WordPress..."

    PROJECT_PATH="/var/www/$PROJECT_NAME"
    cd "$PROJECT_PATH"

    # Verificar archivos principales de WordPress
    if [ -f "wp-load.php" ] && [ -f "wp-config.php" ]; then
        print_status "‚úÖ Archivos principales de WordPress encontrados"
    else
        print_error "‚ùå Archivos principales de WordPress no encontrados"
        return 1
    fi

    # Verificar configuraci√≥n de base de datos
    if grep -q "$DB_NAME" wp-config.php && grep -q "$DB_USER" wp-config.php; then
        print_status "‚úÖ Configuraci√≥n de base de datos verificada"
    else
        print_warning "‚ö†Ô∏è  Problema con la configuraci√≥n de base de datos"
    fi

    # Verificar permisos
    if [ -w "wp-content" ]; then
        print_status "‚úÖ Permisos de escritura verificados"
    else
        print_warning "‚ö†Ô∏è  Problema con permisos de escritura"
    fi

    print_status "Verificaci√≥n completada"
}

# Mostrar informaci√≥n final
show_wordpress_info() {
    echo ""
    echo -e "${GREEN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${GREEN}‚ïë               WordPress Configurado Exitosamente            ‚ïë${NC}"
    echo -e "${GREEN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    echo -e "${CYAN}üöÄ Framework:${NC} WordPress"
    echo -e "${CYAN}üìÅ Proyecto:${NC} $PROJECT_NAME"
    echo -e "${CYAN}üåê URL:${NC} https://$DOMAIN_NAME"
    echo -e "${CYAN}üóÑÔ∏è  Base de datos:${NC} $DB_NAME ($DB_TYPE)"
    echo -e "${CYAN}üè∑Ô∏è  Sufijo tablas:${NC} $TABLE_PREFIX"
    echo ""
    echo -e "${YELLOW}üìã Pr√≥ximos pasos:${NC}"
    echo -e "${YELLOW}‚Ä¢ Visita:${NC} https://$DOMAIN_NAME/wp-admin para completar la instalaci√≥n"
    echo -e "${YELLOW}‚Ä¢ Configurar permalinks desde el admin de WordPress${NC}"
    echo -e "${YELLOW}‚Ä¢ Instalar plugins de seguridad y optimizaci√≥n${NC}"
    echo ""
    echo -e "${YELLOW}üìã Comandos √∫tiles:${NC}"
    echo -e "${YELLOW}‚Ä¢ Ver logs:${NC} tail -f /var/log/nginx/$PROJECT_NAME.error.log"
    echo -e "${YELLOW}‚Ä¢ WP-CLI:${NC} cd /var/www/$PROJECT_NAME && wp --help"
    echo -e "${YELLOW}‚Ä¢ Verificar instalaci√≥n:${NC} wp --path=/var/www/$PROJECT_NAME core verify-checksums"
    echo ""
}

# Funci√≥n principal
main() {
    print_header

    read_deployment_config
    echo ""

    configure_wordpress
    echo ""

    set_wordpress_permissions
    echo ""

    verify_wordpress_installation
    echo ""

    show_wordpress_info
}

# Ejecutar funci√≥n principal
main