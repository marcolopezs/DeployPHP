#!/bin/bash

# Script de configuraci√≥n MariaDB para Laravel Deployment Environment
# Autor: Comunidad Latina
# Descripci√≥n: Configura autom√°ticamente MariaDB y crea base de datos para Laravel

# Colores para mensajes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_status() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[AVISO]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_header() {
    echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${BLUE}‚ïë                   Configuraci√≥n MariaDB                     ‚ïë${NC}"
    echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
}

# Funci√≥n para leer configuraci√≥n del proyecto
read_project_config() {
    if [ ! -f "../../.deployment-config" ]; then
        print_error "Archivo de configuraci√≥n no encontrado"
        exit 1
    fi

    # Cargar variables del archivo de configuraci√≥n
    export $(cat ../../.deployment-config | xargs)

    print_status "Configuraci√≥n del proyecto cargada:"
    echo "  üìÅ Proyecto: $PROJECT_NAME"
    echo "  üåê Dominio: $DOMAIN_NAME"
}

# Funci√≥n para verificar si MariaDB est√° ejecut√°ndose
check_mariadb_status() {
    if systemctl is-active --quiet mariadb; then
        print_status "MariaDB est√° ejecut√°ndose correctamente"
        return 0
    else
        print_error "MariaDB no est√° ejecut√°ndose"
        print_status "Intentando iniciar MariaDB..."
        sudo systemctl start mariadb

        if systemctl is-active --quiet mariadb; then
            print_status "MariaDB iniciado correctamente"
            return 0
        else
            print_error "No se pudo iniciar MariaDB"
            return 1
        fi
    fi
}

# Funci√≥n para configurar MariaDB de forma segura
secure_mariadb_installation() {
    print_status "Configurando MariaDB de forma segura..."

    # Generar contrase√±a aleatoria para root
    ROOT_PASSWORD=$(openssl rand -base64 32)

    # Intentar configuraci√≥n autom√°tica
    if sudo mysql -e "SELECT 1;" >/dev/null 2>&1; then
        print_status "Configurando contrase√±a root de MariaDB..."

        sudo mysql << EOF
SET PASSWORD FOR 'root'@'localhost' = PASSWORD('$ROOT_PASSWORD');
DELETE FROM mysql.user WHERE User='';
DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');
DROP DATABASE IF EXISTS test;
DELETE FROM mysql.db WHERE Db='test' OR Db='test\\_%';
FLUSH PRIVILEGES;
EOF

        # Guardar contrase√±a en archivo seguro
        echo "MARIADB_ROOT_PASSWORD=$ROOT_PASSWORD" | sudo tee /root/.mariadb_credentials > /dev/null
        sudo chmod 600 /root/.mariadb_credentials

        print_status "Configuraci√≥n de seguridad MariaDB completada"
        print_warning "Contrase√±a root guardada en /root/.mariadb_credentials"
    else
        print_warning "MariaDB ya est√° configurado con contrase√±a"
        # Intentar leer contrase√±a existente
        if [ -f "/root/.mariadb_credentials" ]; then
            source /root/.mariadb_credentials
            print_status "Usando contrase√±a root existente"
        else
            print_error "No se puede acceder a MariaDB y no hay credenciales guardadas"
            print_warning "Ejecuta manualmente: sudo mysql_secure_installation"
            return 1
        fi
    fi
}

# Funci√≥n para leer configuraci√≥n de base de datos del proyecto Laravel
read_laravel_database_config() {
    PROJECT_PATH="/var/www/$PROJECT_NAME"

    if [ -f "$PROJECT_PATH/.env" ]; then
        print_status "Leyendo configuraci√≥n de base de datos desde .env..."

        DB_NAME=$(grep "^DB_DATABASE=" "$PROJECT_PATH/.env" | cut -d '=' -f2 | tr -d '"')
        DB_USER=$(grep "^DB_USERNAME=" "$PROJECT_PATH/.env" | cut -d '=' -f2 | tr -d '"')
        DB_PASSWORD=$(grep "^DB_PASSWORD=" "$PROJECT_PATH/.env" | cut -d '=' -f2 | tr -d '"')
        DB_HOST=$(grep "^DB_HOST=" "$PROJECT_PATH/.env" | cut -d '=' -f2 | tr -d '"')

    elif [ -f "$PROJECT_PATH/.env.example" ]; then
        print_warning "Archivo .env no encontrado, usando .env.example como base"

        # Crear configuraci√≥n por defecto
        DB_NAME="${PROJECT_NAME}_db"
        DB_USER="${PROJECT_NAME}_user"
        DB_PASSWORD=$(openssl rand -base64 16)
        DB_HOST="localhost"

    else
        print_error "No se encontr√≥ configuraci√≥n de base de datos"
        print_status "Usando configuraci√≥n por defecto..."

        DB_NAME="${PROJECT_NAME}_db"
        DB_USER="${PROJECT_NAME}_user"
        DB_PASSWORD=$(openssl rand -base64 16)
        DB_HOST="localhost"
    fi

    # Validar que las variables no est√©n vac√≠as
    if [ -z "$DB_NAME" ]; then DB_NAME="${PROJECT_NAME}_db"; fi
    if [ -z "$DB_USER" ]; then DB_USER="${PROJECT_NAME}_user"; fi
    if [ -z "$DB_PASSWORD" ]; then DB_PASSWORD=$(openssl rand -base64 16); fi
    if [ -z "$DB_HOST" ]; then DB_HOST="localhost"; fi

    print_status "Configuraci√≥n de base de datos:"
    echo "  üóÑÔ∏è  Base de datos: $DB_NAME"
    echo "  üë§ Usuario: $DB_USER"
    echo "  üîë Host: $DB_HOST"
}

# Funci√≥n para crear base de datos y usuario
create_database_and_user() {
    print_status "Creando base de datos y usuario..."

    # Intentar conexi√≥n con diferentes m√©todos
    if sudo mysql -e "SELECT 1;" >/dev/null 2>&1; then
        # M√©todo 1: Autenticaci√≥n por socket (sin contrase√±a)
        print_status "Usando autenticaci√≥n por socket..."

        sudo mysql << EOF
CREATE DATABASE IF NOT EXISTS \`$DB_NAME\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER IF NOT EXISTS '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASSWORD';
CREATE USER IF NOT EXISTS '$DB_USER'@'%' IDENTIFIED BY '$DB_PASSWORD';
GRANT ALL PRIVILEGES ON \`$DB_NAME\`.* TO '$DB_USER'@'localhost';
GRANT ALL PRIVILEGES ON \`$DB_NAME\`.* TO '$DB_USER'@'%';
FLUSH PRIVILEGES;
EOF

    elif [ -f "/root/.mariadb_credentials" ]; then
        # M√©todo 2: Usar contrase√±a guardada
        source /root/.mariadb_credentials
        print_status "Usando contrase√±a root guardada..."

        mysql -u root -p"$MARIADB_ROOT_PASSWORD" << EOF
CREATE DATABASE IF NOT EXISTS \`$DB_NAME\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER IF NOT EXISTS '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASSWORD';
CREATE USER IF NOT EXISTS '$DB_USER'@'%' IDENTIFIED BY '$DB_PASSWORD';
GRANT ALL PRIVILEGES ON \`$DB_NAME\`.* TO '$DB_USER'@'localhost';
GRANT ALL PRIVILEGES ON \`$DB_NAME\`.* TO '$DB_USER'@'%';
FLUSH PRIVILEGES;
EOF

    else
        # M√©todo 3: Solicitar contrase√±a manualmente
        print_warning "Se requiere la contrase√±a root de MariaDB"

        mysql -u root -p << EOF
CREATE DATABASE IF NOT EXISTS \`$DB_NAME\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER IF NOT EXISTS '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASSWORD';
CREATE USER IF NOT EXISTS '$DB_USER'@'%' IDENTIFIED BY '$DB_PASSWORD';
GRANT ALL PRIVILEGES ON \`$DB_NAME\`.* TO '$DB_USER'@'localhost';
GRANT ALL PRIVILEGES ON \`$DB_NAME\`.* TO '$DB_USER'@'%';
FLUSH PRIVILEGES;
EOF
    fi

    if [ $? -eq 0 ]; then
        print_status "Base de datos y usuario creados exitosamente"
    else
        print_error "Error al crear base de datos y usuario"
        return 1
    fi
}

# Funci√≥n para probar la conexi√≥n
test_database_connection() {
    print_status "Probando conexi√≥n a la base de datos..."

    if mysql -u "$DB_USER" -p"$DB_PASSWORD" -h "$DB_HOST" -e "USE \`$DB_NAME\`; SHOW TABLES;" 2>/dev/null; then
        print_status "‚úÖ Conexi√≥n a la base de datos exitosa"
        return 0
    else
        print_warning "‚ö†Ô∏è  Conexi√≥n fallida, pero la base de datos fue creada"
        print_warning "Esto puede deberse a restricciones de red"
        return 0
    fi
}

# Funci√≥n para actualizar archivo .env del proyecto
update_laravel_env() {
    PROJECT_PATH="/var/www/$PROJECT_NAME"
    ENV_FILE="$PROJECT_PATH/.env"

    print_status "Actualizando configuraci√≥n de Laravel..."

    # Crear .env si no existe
    if [ ! -f "$ENV_FILE" ]; then
        if [ -f "$PROJECT_PATH/.env.example" ]; then
            cp "$PROJECT_PATH/.env.example" "$ENV_FILE"
            print_status "Archivo .env creado desde .env.example"
        else
            print_error "No se encontr√≥ .env.example"
            return 1
        fi
    fi

    # Actualizar configuraci√≥n de base de datos
    sed -i "s/^DB_CONNECTION=.*/DB_CONNECTION=mysql/" "$ENV_FILE"
    sed -i "s/^DB_HOST=.*/DB_HOST=$DB_HOST/" "$ENV_FILE"
    sed -i "s/^DB_PORT=.*/DB_PORT=3306/" "$ENV_FILE"
    sed -i "s/^DB_DATABASE=.*/DB_DATABASE=$DB_NAME/" "$ENV_FILE"
    sed -i "s/^DB_USERNAME=.*/DB_USERNAME=$DB_USER/" "$ENV_FILE"
    sed -i "s/^DB_PASSWORD=.*/DB_PASSWORD=$DB_PASSWORD/" "$ENV_FILE"

    print_status "Archivo .env actualizado con la configuraci√≥n de base de datos"
}

# Funci√≥n para optimizar MariaDB para Laravel
optimize_mariadb_for_laravel() {
    print_status "Optimizando MariaDB para Laravel..."

    # Crear archivo de configuraci√≥n personalizado
    sudo tee /etc/mysql/mariadb.conf.d/laravel-optimization.cnf > /dev/null << EOF
[mysqld]
# Optimizaciones para Laravel con MariaDB
innodb_buffer_pool_size = 256M
innodb_log_file_size = 64M
innodb_flush_log_at_trx_commit = 2
innodb_flush_method = O_DIRECT

# Configuraci√≥n de caracteres
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

# Configuraci√≥n de conexiones
max_connections = 200
max_user_connections = 180

# Cache de consultas (mejorado en MariaDB)
query_cache_type = 1
query_cache_size = 64M
query_cache_limit = 4M

# Timeouts
wait_timeout = 28800
interactive_timeout = 28800

# Configuraci√≥n espec√≠fica de MariaDB
innodb_adaptive_hash_index = ON
innodb_change_buffering = all
innodb_old_blocks_time = 1000

# Threading
thread_pool_size = 4
thread_pool_max_threads = 64

# Configuraci√≥n de logs
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2

# Aria Storage Engine (espec√≠fico de MariaDB)
aria_log_file_size = 64M
aria_sort_buffer_size = 64M
EOF

    # Reiniciar MariaDB para aplicar cambios
    sudo systemctl restart mariadb

    if systemctl is-active --quiet mariadb; then
        print_status "MariaDB optimizado y reiniciado correctamente"
    else
        print_error "Error al reiniciar MariaDB despu√©s de la optimizaci√≥n"
        # Restaurar configuraci√≥n original si hay problemas
        sudo rm -f /etc/mysql/mariadb.conf.d/laravel-optimization.cnf
        sudo systemctl restart mariadb
        print_warning "Configuraci√≥n de optimizaci√≥n removida"
    fi
}

# Funci√≥n para crear script de respaldo
create_backup_script() {
    print_status "Creando script de respaldo autom√°tico..."

    BACKUP_SCRIPT="/usr/local/bin/backup-$PROJECT_NAME-mariadb.sh"

    sudo tee "$BACKUP_SCRIPT" > /dev/null << EOF
#!/bin/bash
# Script de respaldo autom√°tico MariaDB para $PROJECT_NAME
# Generado por Laravel Deployment Environment

DATE=\$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/var/backups/mariadb"
DB_NAME="$DB_NAME"
DB_USER="$DB_USER"
DB_PASSWORD="$DB_PASSWORD"

# Crear directorio de respaldos
mkdir -p \$BACKUP_DIR

# Crear respaldo con compresi√≥n optimizada
mariadb-dump -u \$DB_USER -p\$DB_PASSWORD \$DB_NAME | gzip -9 > \$BACKUP_DIR/\${DB_NAME}_\${DATE}.sql.gz

# Verificar integridad del respaldo
if [ \$? -eq 0 ]; then
    echo "‚úÖ Respaldo exitoso: \$BACKUP_DIR/\${DB_NAME}_\${DATE}.sql.gz"

    # Crear respaldo semanal (domingos)
    if [ \$(date +%w) -eq 0 ]; then
        cp \$BACKUP_DIR/\${DB_NAME}_\${DATE}.sql.gz \$BACKUP_DIR/\${DB_NAME}_weekly_\${DATE}.sql.gz
        echo "üìÖ Respaldo semanal creado"
    fi

    # Crear respaldo mensual (d√≠a 1)
    if [ \$(date +%d) -eq 01 ]; then
        cp \$BACKUP_DIR/\${DB_NAME}_\${DATE}.sql.gz \$BACKUP_DIR/\${DB_NAME}_monthly_\${DATE}.sql.gz
        echo "üìÖ Respaldo mensual creado"
    fi
else
    echo "‚ùå Error en el respaldo"
    exit 1
fi

# Limpiar respaldos antiguos
find \$BACKUP_DIR -name "\${DB_NAME}_*.sql.gz" -mtime +7 -delete
find \$BACKUP_DIR -name "\${DB_NAME}_weekly_*.sql.gz" -mtime +30 -delete
find \$BACKUP_DIR -name "\${DB_NAME}_monthly_*.sql.gz" -mtime +365 -delete

echo "üßπ Limpieza de respaldos antiguos completada"
EOF

    sudo chmod +x "$BACKUP_SCRIPT"

    # Agregar tarea cron para respaldo diario
    (sudo crontab -l 2>/dev/null; echo "0 2 * * * $BACKUP_SCRIPT") | sudo crontab -

    print_status "Script de respaldo creado: $BACKUP_SCRIPT"
    print_status "Respaldo autom√°tico programado para las 2:00 AM diariamente"
}

# Funci√≥n para mostrar informaci√≥n de rendimiento
show_mariadb_performance_info() {
    print_status "Informaci√≥n de rendimiento de MariaDB:"

    # Mostrar versi√≥n de MariaDB
    MARIADB_VERSION=$(mysql --version | grep -oP 'mariadb-\K[0-9]+\.[0-9]+\.[0-9]+')
    echo "  üìä Versi√≥n MariaDB: $MARIADB_VERSION"

    # Mostrar caracter√≠sticas espec√≠ficas de MariaDB
    echo "  ‚ö° Caracter√≠sticas habilitadas:"
    echo "    ‚Ä¢ Thread Pool: Activado"
    echo "    ‚Ä¢ Aria Storage Engine: Optimizado"
    echo "    ‚Ä¢ Query Cache: 64MB"
    echo "    ‚Ä¢ InnoDB Buffer Pool: 256MB"
}

# Funci√≥n principal
main() {
    print_header

    print_status "Iniciando configuraci√≥n de MariaDB para Laravel..."
    echo ""

    # Ejecutar pasos de configuraci√≥n
    read_project_config
    echo ""

    check_mariadb_status || exit 1
    echo ""

    secure_mariadb_installation || exit 1
    echo ""

    read_laravel_database_config
    echo ""

    create_database_and_user || exit 1
    echo ""

    test_database_connection
    echo ""

    update_laravel_env || exit 1
    echo ""

    optimize_mariadb_for_laravel
    echo ""

    create_backup_script
    echo ""

    show_mariadb_performance_info
    echo ""

    print_status "üéâ Configuraci√≥n de MariaDB completada exitosamente"
    echo ""
    echo -e "${GREEN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${GREEN}‚ïë                    Resumen de Configuraci√≥n                 ‚ïë${NC}"
    echo -e "${GREEN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo "  üóÑÔ∏è  Base de datos: $DB_NAME"
    echo "  üë§ Usuario: $DB_USER"
    echo "  üîë Host: $DB_HOST"
    echo "  üìÅ Proyecto: $PROJECT_NAME"
    echo "  üîí Archivo .env actualizado"
    echo "  ‚ö° MariaDB optimizado para Laravel"
    echo "  üíæ Respaldo autom√°tico configurado"
    echo "  üöÄ Thread Pool habilitado"
    echo ""
    print_warning "Guarda esta informaci√≥n de forma segura"
}

# Ejecutar funci√≥n principal
main